{% extends 'base.html' %}
{% block title %}My Profile - LocalFreelance AI{% endblock %}
{% block content %}
<div class="profile-page">
  <div class="container">
    <div class="profile-header">
      <h1>My Profile</h1>
      <a href="/dashboard/client/" class="btn btn-outline">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="19" y1="12" x2="5" y2="12"></line>
          <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
        Back to Dashboard
      </a>
    </div>

    <div class="profile-content">
      <div class="profile-card dashboard-card dashboard-card-wide">
        <div class="card-header">
          <h3>Profile Information</h3>
        </div>
        <p style="margin-bottom: 16px; color: #6b7280;">Update your contact information so freelancers can reach you about your posted work.</p>
        <form id="profile-form" class="work-form">
          <div class="form-row">
            <div class="form-group">
              <label for="profile-full-name">Full Name</label>
              <input
                type="text"
                id="profile-full-name"
                name="full_name"
                required
                placeholder="Your full name"
              />
            </div>
            <div class="form-group">
              <label for="profile-phone">Phone Number</label>
              <input
                type="tel"
                id="profile-phone"
                name="phone"
                required
                placeholder="e.g., +1 (555) 123-4567"
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="profile-city">City</label>
              <input
                type="text"
                id="profile-city"
                name="city"
                placeholder="e.g., New York, NY"
              />
            </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Profile</button>
          </div>
        </form>
      </div>

      <div class="profile-card dashboard-card dashboard-card-wide">
        <div class="card-header">
          <h3>Account Information</h3>
        </div>
        <div id="account-info">
          <div class="loading">Loading...</div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_css %}
<style>
  .profile-page {
    padding: 24px 0;
  }
  .profile-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }
  .profile-header .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  .profile-content {
    max-width: 800px;
  }
  .profile-card {
    margin-bottom: 24px;
  }
  .account-info-item {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid #e5e7eb;
  }
  .account-info-item:last-child {
    border-bottom: none;
  }
  .account-info-label {
    font-weight: 500;
    color: #6b7280;
  }
  .account-info-value {
    color: #111827;
  }
</style>
{% endblock %} {% block extra_js %}
<script>
  // Load user profile on page load
  async function loadProfile() {
    const token = AuthManager.getAccessToken();
    if (!token) {
      showToast("Please login first", "error");
      setTimeout(() => window.location.href = "/login/", 1500);
      return;
    }

    try {
      // Get user info
      const userRes = await fetch("/api/auth/me/", {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });

      if (!userRes.ok) {
        showToast("Error loading user info", "error");
        return;
      }

      const user = await userRes.json();

      // Get client profile
      const profileRes = await fetch("/api/auth/client/profile/", {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });

      let profile = {};
      if (profileRes.ok) {
        profile = await profileRes.json();
      }

      document.getElementById("profile-full-name").value = profile.full_name || "";
      document.getElementById("profile-phone").value = profile.phone || "";
      document.getElementById("profile-city").value = profile.city || "";

      // Display account info
      document.getElementById("account-info").innerHTML = `
        <div class="account-info-item">
          <span class="account-info-label">Email</span>
          <span class="account-info-value">${user.email || "N/A"}</span>
        </div>
        <div class="account-info-item">
          <span class="account-info-label">Account Type</span>
          <span class="account-info-value">${user.role === "freelancer" ? "Freelancer" : "Client"}</span>
        </div>
        <div class="account-info-item">
          <span class="account-info-label">Member Since</span>
          <span class="account-info-value">${user.date_joined ? new Date(user.date_joined).toLocaleDateString() : "N/A"}</span>
        </div>
      `;
    } catch (error) {
      console.error("Error loading profile:", error);
      showToast("Error loading profile", "error");
    }
  }

  // Handle profile form submission
  const profileForm = document.getElementById("profile-form");
  if (profileForm) {
    profileForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const token = AuthManager.getAccessToken();
      if (!token) {
        showToast("Please login first", "error");
        return;
      }

      const formData = new FormData(profileForm);
      const data = {
        full_name: formData.get("full_name"),
        phone: formData.get("phone"),
        city: formData.get("city"),
      };

      try {
        const res = await fetch("/api/auth/client/profile/", {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(data),
        });

        if (res.ok) {
          showToast("Profile saved successfully!", "success");
        } else {
          const error = await res.json();
          showToast(error.error || "Failed to save profile", "error");
        }
      } catch (error) {
        console.error("Error saving profile:", error);
        showToast("Error saving profile", "error");
      }
    });
  }

  document.addEventListener("DOMContentLoaded", loadProfile);
</script>
{% endblock %}
